name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check_changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    outputs:
      typescript_changed: ${{ steps.changes.outputs.typescript }}
      rust_changed: ${{ steps.changes.outputs.rust }}
      share_changed: ${{ steps.changes.outputs.share }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.base_ref || 'main' }}"
            if ! git show-ref --verify --quiet refs/remotes/origin/$BASE_REF; then
              if git show-ref --verify --quiet refs/remotes/origin/main; then
                BASE_REF="main"
              else
                BASE_REF="master"
              fi
            fi
            BASE="origin/$BASE_REF"
          else
            # For push events, compare against previous commit
            # If HEAD~1 doesn't exist (first commit), force all checks
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              BASE="HEAD~1"
            else
              # First commit - force all checks
              echo "typescript=true" >> $GITHUB_OUTPUT
              echo "rust=true" >> $GITHUB_OUTPUT
              echo "share=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          TYPESCRIPT_CHANGED="false"
          RUST_CHANGED="false"
          SHARE_CHANGED="false"

          CHANGED_FILES=$(git diff --name-only $BASE HEAD || echo "")

          if echo "$CHANGED_FILES" | grep -q "^typescript-workspace/"; then
            TYPESCRIPT_CHANGED="true"
          fi

          if echo "$CHANGED_FILES" | grep -q "^rust-workspace/"; then
            RUST_CHANGED="true"
          fi

          if echo "$CHANGED_FILES" | grep -q "^share/"; then
            SHARE_CHANGED="true"
          fi

          # CI/CD changes force both workspaces to run
          if echo "$CHANGED_FILES" | grep -q "^\.github/workflows/"; then
            TYPESCRIPT_CHANGED="true"
            RUST_CHANGED="true"
          fi

          echo "typescript=$TYPESCRIPT_CHANGED" >> $GITHUB_OUTPUT
          echo "rust=$RUST_CHANGED" >> $GITHUB_OUTPUT
          echo "share=$SHARE_CHANGED" >> $GITHUB_OUTPUT

  ts_lint:
    name: TypeScript Lint (all)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (needs.check_changes.outputs.typescript_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    defaults:
      run:
        working-directory: typescript-workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        id: get-pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Lint (workspace-wide)
        run: pnpm turbo lint

  ts_test:
    name: TypeScript Test (all)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (needs.check_changes.outputs.typescript_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    defaults:
      run:
        working-directory: typescript-workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        id: get-pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Test (workspace-wide)
        run: pnpm turbo test

  ts_test_changed:
    name: TypeScript Test (changed only)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master')) && (needs.check_changes.outputs.typescript_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    defaults:
      run:
        working-directory: typescript-workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run tests only for changed packages since base branch
        env:
          BASE_REF: ${{ github.base_ref || 'main' }}
        run: |
          # Fallback to master if main doesn't exist
          if git show-ref --verify --quiet refs/remotes/origin/$BASE_REF; then
            BASE=origin/$BASE_REF
          elif git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE=origin/main
          else
            BASE=origin/master
          fi
          # If no test scripts exist, this will be a no-op; Turbo will skip
          pnpm turbo run test --filter="...[${BASE}]"

  ts_lint_changed:
    name: TypeScript Lint (changed only)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master')) && (needs.check_changes.outputs.typescript_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    defaults:
      run:
        working-directory: typescript-workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run lint only for changed packages since base branch
        env:
          BASE_REF: ${{ github.base_ref || 'main' }}
        run: |
          # Fallback to master if main doesn't exist
          if git show-ref --verify --quiet refs/remotes/origin/$BASE_REF; then
            BASE=origin/$BASE_REF
          elif git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE=origin/main
          else
            BASE=origin/master
          fi
          # If no lint scripts exist, this will be a no-op; Turbo will skip
          pnpm turbo run lint --filter="...[${BASE}]"

  rust_lint:
    name: Rust Lint (all)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (needs.check_changes.outputs.rust_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    defaults:
      run:
        working-directory: rust-workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cargo cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: rust-workspace -> target

      - name: rustfmt (check)
        run: cargo fmt --all -- --check

      - name: clippy (deny warnings)
        run: cargo clippy --workspace --all-targets -- -D warnings

  rust_test:
    name: Rust Test (all)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (needs.check_changes.outputs.rust_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    defaults:
      run:
        working-directory: rust-workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: rust-workspace -> target

      - name: Test (workspace-wide)
        run: cargo test --workspace

  rust_lint_changed:
    name: Rust Lint (changed only)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master')) && (needs.check_changes.outputs.rust_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cargo cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: rust-workspace -> target

      - name: Run lint for changed crates only
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          bash scripts/changed-rust-lint.sh

  rust_test_changed:
    name: Rust Test (changed only)
    runs-on: ubuntu-latest
    needs: check_changes
    if: (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master')) && (needs.check_changes.outputs.rust_changed == 'true' || needs.check_changes.outputs.share_changed == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: rust-workspace -> target

      - name: Run tests for changed crates only
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          bash scripts/changed-rust-crates.sh

  build_docker_images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build server image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/server.Dockerfile
          push: false
          tags: tripvota-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/web.Dockerfile
          push: false
          tags: tripvota-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
